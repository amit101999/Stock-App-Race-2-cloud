#!/usr/bin/env node
'use strict';
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("util");
const ansi_colors_1 = require("ansi-colors");
const path_1 = require("path");
const SYNC = __importStar(require("../util_modules/fs/lib/sync.js"));
const runtime_store_js_1 = __importDefault(require("../runtime-store.js"));
const pkg = SYNC.readPackageJson();
if (!pkg) {
    console.error('Package corrupted!!. Re-install zcatalyst-cli and try again.');
    process.exit(1);
}
runtime_store_js_1.default.set('cli.package', pkg);
const index_js_1 = require("../index.js");
index_js_1.Catalyst.init();
const config_store_js_1 = __importDefault(require("../util_modules/config-store.js"));
const file_names_js_1 = __importDefault(require("../util_modules/constants/lib/file-names.js"));
const index_1 = require("../util_modules/logger/index");
const errorOut_1 = __importDefault(require("../errorOut"));
const updateNotifierPromise = Promise.resolve().then(() => __importStar(require('update-notifier')));
(0, index_1.debug)();
(0, index_1.debug)('-'.repeat(70));
(0, index_1.debug)((0, ansi_colors_1.bold)('Command:      ') + process.argv.join(' '));
(0, index_1.debug)((0, ansi_colors_1.bold)('CLI Version:  ') + pkg.version);
(0, index_1.debug)((0, ansi_colors_1.bold)('Platform:     ') + process.platform);
(0, index_1.debug)((0, ansi_colors_1.bold)('Node Version: ') + process.version);
(0, index_1.debug)((0, ansi_colors_1.bold)('Time:         ') + new Date().toString());
(0, index_1.debug)('-'.repeat(70));
(0, index_1.debug)();
process.on('beforeExit', (code) => __awaiter(void 0, void 0, void 0, function* () {
    code = Number(process.exitCode) || code;
    if (code > 0 && process.stdout.isTTY) {
        const lastError = config_store_js_1.default.get('lastError', 0);
        const timestamp = Date.now();
        if (lastError > timestamp - 120000) {
            let help;
            const cmd = yield cmdPromise;
            if (code === 1 && cmd) {
                const commandName = cmd.name() || '[command]';
                help = 'Having trouble? Try ' + (0, ansi_colors_1.bold)('catalyst ' + commandName + ' --help');
            }
            else {
                help =
                    'Having trouble? Try again or contact support with contents of ' + file_names_js_1.default.log;
            }
            if (cmd) {
                console.log('\n' + help);
            }
        }
        config_store_js_1.default.set('lastError', timestamp);
    }
    else {
        config_store_js_1.default.delete('lastError');
    }
    if (pkg.name) {
        (yield updateNotifierPromise)
            .default({
            pkg: {
                name: pkg.name,
                version: pkg.version
            },
            updateCheckInterval: 1000 * 60 * 15
        })
            .notify();
    }
    process.exit(code);
}));
process.on('exit', (code) => {
    const logFile = (0, path_1.join)(runtime_store_js_1.default.get('cwd', process.cwd()), file_names_js_1.default.log);
    if (code < 2 && SYNC.fileExists(logFile)) {
        SYNC.deleteFile(logFile);
    }
    require('update-notifier')({
        pkg,
        updateCheckInterval: 1000 * 60 * 15
    }).notify({ defer: false, isGlobal: true });
});
process.on('uncaughtException', (err) => {
    (0, errorOut_1.default)(err);
    process.exitCode = runtime_store_js_1.default.get('exitCode', 2);
});
process.on('unhandledRejection', (reason, promise) => {
    (0, errorOut_1.default)((0, util_1.inspect)(reason || promise));
    process.exitCode = runtime_store_js_1.default.get('exitCode', 2);
});
let cmdPromise;
if (process.stdin.isTTY) {
    cmdPromise = index_js_1.Catalyst.processArgs(...process.argv);
}
else {
    let stdin = '';
    process.stdin.on('data', (chunk) => {
        if (chunk !== null) {
            stdin += chunk;
        }
    });
    process.stdin.on('end', () => {
        cmdPromise = index_js_1.Catalyst.processArgs(...process.argv, stdin.toString().trimEnd());
    });
}
