"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const shell_1 = require("../../../util_modules/shell");
const project_1 = require("../../../util_modules/project");
const constants_1 = require("../../../util_modules/constants");
const path_1 = require("path");
exports.default = (fn, data, { slaveFnTarget, accessToken }) => {
    var _a, _b, _c, _d;
    const slaveOptions = [];
    const nodeInvoker = (0, path_1.normalize)((0, path_1.join)(__dirname, '../invoker', (_a = fn.target) === null || _a === void 0 ? void 0 : _a.type, 'node.mjs'));
    if (fn.debugPort !== -1) {
        slaveOptions.push('--inspect-brk=' + fn.debugPort);
    }
    slaveOptions.push(nodeInvoker);
    slaveOptions.push(JSON.stringify(slaveFnTarget));
    slaveOptions.push(data);
    slaveOptions.push(JSON.stringify({
        'x-zc-projectid': (0, project_1.getProjectId)(),
        'x-zc-project-domain': (0, project_1.getDomainPrefix)() + '.' + constants_1.ORIGIN.app.replace('https://', ''),
        'x-zc-project-key': (0, project_1.getDomainKey)(),
        'x-zc-environment': (0, project_1.getEnvName)()
    }));
    slaveOptions.push(JSON.stringify({
        'x-zc-user-cred-type': 'token',
        'x-zc-user-cred-token': accessToken,
        'x-zc-admin-cred-type': 'token',
        'x-zc-admin-cred-token': accessToken,
        'x-zc-user-type': 'admin'
    }));
    slaveOptions.push(JSON.stringify((0, path_1.join)((0, project_1.getProjectRoot)(), constants_1.FOLDERNAME.build)));
    return (0, shell_1.spawn)('node', slaveOptions, {
        cwd: (_b = fn.target) === null || _b === void 0 ? void 0 : _b.build,
        stdio: 'pipe',
        env: Object.assign({ X_ZOHO_CATALYST_IS_LOCAL: 'true', X_ZOHO_CATALYST_FUNCTION_LOADED: 'true', X_ZOHO_CATALYST_ACCOUNTS_URL: constants_1.ORIGIN.auth, CATALYST_PORTAL_DOMAIN: constants_1.ORIGIN.iamPortal, X_ZOHO_CATALYST_CONSOLE_URL: constants_1.ORIGIN.admin, X_ZOHO_CATALYST_RESOURCE_ID: (_c = fn.target) === null || _c === void 0 ? void 0 : _c.id, X_ZOHO_STRATUS_RESOURCE_SUFFIX: constants_1.ORIGIN.stratusSuffix, CATALYST_PROJECT_TIMEZONE: (0, project_1.getProjectTimezone)(Intl.DateTimeFormat().resolvedOptions().timeZone) }, (_d = fn.target) === null || _d === void 0 ? void 0 : _d.env_var)
    }).RAW();
};
